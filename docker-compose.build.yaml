# Local development compose file - builds images from source
# Usage: docker compose -f docker-compose.build.yaml up --build

services:
  postgres:
    image: postgres:16-alpine
    container_name: feedmob-adpilot-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-feedmob}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-feedmob_adpilot}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - adpilot-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-feedmob} -d ${POSTGRES_DB:-feedmob_adpilot}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: feedmob-adpilot-mcp
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-feedmob}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-feedmob_adpilot}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_RETRY_MODE: ${AWS_RETRY_MODE:-adaptive}
      AWS_MAX_ATTEMPTS: ${AWS_MAX_ATTEMPTS:-20}
      CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-1}
      ANTHROPIC_SMALL_FAST_MODEL: ${ANTHROPIC_SMALL_FAST_MODEL:-us.anthropic.claude-haiku-4-5-20251001-v1:0}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-us.anthropic.claude-sonnet-4-5-20250929-v1:0}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      IMAGEKIT_PRIVATE_KEY: ${IMAGEKIT_PRIVATE_KEY}
      IMAGEKIT_PUBLIC_KEY: ${IMAGEKIT_PUBLIC_KEY}
      IMAGEKIT_URL_ENDPOINT: ${IMAGEKIT_URL_ENDPOINT}
      NODE_ENV: production
    networks:
      - adpilot-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  client-ui:
    build:
      context: ./client-ui
      dockerfile: Dockerfile
    container_name: feedmob-adpilot-ui
    restart: unless-stopped
    environment:
      MCP_SERVER_URL: ${MCP_SERVER_URL:-http://mcp-server:8080/mcp}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      BEDROCK_MODEL_ID: ${BEDROCK_MODEL_ID:-us.anthropic.claude-haiku-4-5-20251001-v1:0}
      NODE_ENV: production
    networks:
      - adpilot-network
    depends_on:
      mcp-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  adpilot-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
