# Requirements Document

## Introduction

This feature adds data persistence to the FeedMob AdPilot MCP tools, enabling campaign information to flow between tool calls using a unique campaign ID. Currently, each tool operates independently without persisting data, requiring users to manually pass all campaign information between tool calls. This feature will store campaign data in PostgreSQL, allowing the `parseAdRequirements` tool to generate a campaign ID that subsequent tools (`conductAdResearch`, `generateAdCopy`, `generateAdImages`, `generateMixedMediaCreative`) can use to retrieve and update campaign information.

## Glossary

- **Campaign**: A complete advertising campaign workflow containing requirements, research, ad copy, images, and mixed media creatives
- **Campaign ID**: A unique UUID identifier generated when campaign requirements are first parsed
- **Campaign Parameters**: Structured data extracted from natural language input (product, audience, budget, platform, etc.)
- **Campaign Report**: Research findings and recommendations generated by the ad research tool
- **Ad Copy**: Generated headline, body copy, and CTA variations for the campaign
- **Ad Images**: AI-generated image variations for the campaign
- **Mixed Media Creative**: Final composite combining selected image and ad copy
- **MCP Tool**: A Model Context Protocol tool that can be invoked by LLM clients
- **PostgreSQL**: The relational database used for persistent storage

## Requirements

### Requirement 1

**User Story:** As an advertiser, I want my campaign requirements to be saved with a unique ID, so that I can reference them in subsequent tool calls without re-entering all information.

#### Acceptance Criteria

1. WHEN the parseAdRequirements tool is called without a campaign ID THEN the Campaign_Persistence_System SHALL generate a new UUID campaign ID and store the parameters in PostgreSQL
2. WHEN the parseAdRequirements tool is called with an optional campaign ID THEN the Campaign_Persistence_System SHALL update the existing campaign parameters instead of creating a new campaign
3. WHEN campaign parameters are stored THEN the Campaign_Persistence_System SHALL return the campaign ID in both the text response and UI resource
4. WHEN storing campaign parameters THEN the Campaign_Persistence_System SHALL record the creation timestamp and update timestamp
5. IF the database connection fails during storage THEN the Campaign_Persistence_System SHALL return an error message indicating the storage failure while still returning the extracted parameters
6. IF the provided campaign ID does not exist in the database THEN the Campaign_Persistence_System SHALL return an error message indicating the campaign was not found

### Requirement 2

**User Story:** As an advertiser, I want to conduct research using my campaign ID, so that I don't need to re-enter campaign parameters.

#### Acceptance Criteria

1. WHEN the conductAdResearch tool receives a campaign ID THEN the Campaign_Persistence_System SHALL retrieve the stored campaign parameters from PostgreSQL
2. WHEN research is completed THEN the Campaign_Persistence_System SHALL store the campaign report linked to the campaign ID
3. IF the campaign ID does not exist in the database THEN the Campaign_Persistence_System SHALL return an error message indicating the campaign was not found
4. WHEN the conductAdResearch tool receives both a campaign ID and inline campaign parameters THEN the Campaign_Persistence_System SHALL use the inline parameters and update the stored record

### Requirement 3

**User Story:** As an advertiser, I want to generate ad copy using my campaign ID, so that the tool can access both my requirements and research findings.

#### Acceptance Criteria

1. WHEN the generateAdCopy tool receives a campaign ID THEN the Campaign_Persistence_System SHALL retrieve both campaign parameters and campaign report from PostgreSQL
2. WHEN ad copy variations are generated THEN the Campaign_Persistence_System SHALL store the variations linked to the campaign ID
3. IF the campaign ID exists but has no research report THEN the Campaign_Persistence_System SHALL generate ad copy using only the campaign parameters
4. WHEN ad copy is stored THEN the Campaign_Persistence_System SHALL preserve all variation details including headline, body copy, CTA, and recommendation

### Requirement 4

**User Story:** As an advertiser, I want to generate ad images using my campaign ID, so that the tool can access my requirements, research, and selected ad copy.

#### Acceptance Criteria

1. WHEN the generateAdImages tool receives a campaign ID THEN the Campaign_Persistence_System SHALL retrieve campaign parameters, campaign report, and ad copy from PostgreSQL
2. WHEN image variations are generated THEN the Campaign_Persistence_System SHALL store the image URLs and metadata linked to the campaign ID
3. WHEN a user selects an ad copy variation THEN the Campaign_Persistence_System SHALL store the selection with the campaign record
4. IF the campaign ID exists but has no ad copy THEN the Campaign_Persistence_System SHALL generate images using only the campaign parameters and optional research

### Requirement 5

**User Story:** As an advertiser, I want to generate mixed media creatives using my campaign ID, so that the tool can access all my campaign assets.

#### Acceptance Criteria

1. WHEN the generateMixedMediaCreative tool receives a campaign ID THEN the Campaign_Persistence_System SHALL retrieve the selected image and ad copy from PostgreSQL
2. WHEN a mixed media creative is generated THEN the Campaign_Persistence_System SHALL store the composite image URL and metadata linked to the campaign ID
3. IF the campaign ID exists but has no selected image or ad copy THEN the Campaign_Persistence_System SHALL return an error indicating the required assets are missing
4. WHEN storing mixed media results THEN the Campaign_Persistence_System SHALL record which image variation and ad copy variation were used

### Requirement 6

**User Story:** As an advertiser, I want to retrieve my complete campaign data at any time, so that I can review all generated assets and their history.

#### Acceptance Criteria

1. WHEN a getCampaign tool receives a campaign ID THEN the Campaign_Persistence_System SHALL return all stored campaign data including parameters, research, ad copy, images, and mixed media
2. WHEN returning campaign data THEN the Campaign_Persistence_System SHALL include timestamps for each component showing when it was created and last updated
3. IF the campaign ID does not exist THEN the Campaign_Persistence_System SHALL return an error message indicating the campaign was not found
4. WHEN returning campaign data THEN the Campaign_Persistence_System SHALL indicate which components have been completed and which are pending

### Requirement 7

**User Story:** As a developer, I want the database schema to support the campaign workflow, so that all campaign data can be stored and retrieved efficiently.

#### Acceptance Criteria

1. WHEN the database is initialized THEN the Campaign_Persistence_System SHALL create a campaigns table with columns for id, parameters, research, ad_copy, images, mixed_media, created_at, and updated_at
2. WHEN storing JSON data THEN the Campaign_Persistence_System SHALL use PostgreSQL JSONB columns for flexible schema storage
3. WHEN querying campaigns THEN the Campaign_Persistence_System SHALL use indexed lookups on the campaign ID for efficient retrieval
4. WHEN the application starts THEN the Campaign_Persistence_System SHALL verify database connectivity and run any pending migrations

### Requirement 8

**User Story:** As a developer, I want a database service that handles all persistence operations, so that tools can easily store and retrieve campaign data.

#### Acceptance Criteria

1. WHEN a tool needs to store data THEN the Campaign_Persistence_System SHALL provide a typed interface for each data type (parameters, research, ad_copy, images, mixed_media)
2. WHEN a tool needs to retrieve data THEN the Campaign_Persistence_System SHALL return typed objects matching the existing Zod schemas
3. WHEN database operations fail THEN the Campaign_Persistence_System SHALL throw descriptive errors that tools can handle gracefully
4. WHEN the database connection pool is exhausted THEN the Campaign_Persistence_System SHALL queue requests and retry with exponential backoff
